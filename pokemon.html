<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pokemon overview</title>
  </head>
  <body>
    <div class="container">
      <h1>Pokemon Overview</h1>

      <div class="tabs">
        <span onclick="changeTab('all')" id="tab-all">All</span>
        <span onclick="changeTab('saved')" id="tab-saved">my favorite</span>
      </div>

      <button id="myBtn">create</button>

      <form>
        <div class="filters">
          <span>select type</span>
          <div id="filter-type"></div>
          <button type="submit">Filter</button>
        </div>
      </form>

      <section id="pokmans"></section>
    </div>

    <div id="myModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="create-name-section">
          <label>Name:</label>
          <input id="create-name" />
        </div>
        <div id="create-type-section"></div>
        <div id="modal-btn">
          <button onclick="createPokman(0)" class="save">save</button>
        </div>
      </div>
    </div>

    <script>
      const url = "https://pokeapi.co/api/v2/pokemon?offset=0&limit=50";
      const url_types = "https://pokeapi.co/api/v2/type/";
      let pokmansContainer = document.getElementById("pokmans");
      let pokmans = [];
      let types = [];
      const urlParams = new URLSearchParams(window.location.search);
      const urlFilterType = urlParams.get("type");

      if (urlFilterType) {
        getFilterData(urlFilterType);
      } else {
        if (JSON.parse(localStorage.getItem("pokmans")))
          getAllDataFromLocal(JSON.parse(localStorage.getItem("pokmans")));
        else getAllData();
      }
      gettypes();
      ModalForCreatePokman();

      async function getAllData() {
        let res = await fetch(url).then((response) => response.json());
        let fetchresult = res.results;
        let htmlCards = "";
        let len = 50;
        if (fetchresult.length < 50) {
          len = fetchresult.length;
        }
        for (let i = 0; i <= len - 1; i++) {
          let item = fetchresult[i];
          let newdata = await fetch(item.url).then((response) =>
            response.json()
          );

          let data = {
            id: newdata.id,
            image: newdata.sprites.other.home.front_default,
            name: newdata.name,
            url: item.url,
            type: newdata.types[0].type,
          };

          pokmans.push(data);
          localStorage.setItem("pokmans", JSON.stringify(pokmans));
          let card = getCard(data);
          htmlCards += card;
        }
        pokmansContainer.innerHTML = htmlCards;
        setBackgroundColor(pokmans);
      }

      async function  getAllDataFromLocal(fetchresult){
                        pokmans=[];
                        let htmlCards = "";
                        let len=50;
                        if(fetchresult.length<50){
                            len = fetchresult.length;
                        }
                       for(let i=0;i<=len-1;i++){
                        let data = fetchresult[i];
                        pokmans.push(data);
                        let card = getCard(data);
                        htmlCards +=card;
                        }

                        pokmansContainer.innerHTML=(htmlCards);
                        setBackgroundColor(fetchresult);
                       
                    }
                    async function  gettypes(){
                 
                 const pokmans_types= JSON.parse(localStorage.getItem("pokmans_types"));

                 if(pokmans_types){
              
                     types= pokmans_types;
                 } else{
                     
                 let res = await fetch(url_types).then(response => response.json())

               
                     types = res.results.map(item=>{
                     var randomColor = getRandomColor();
                         
                      return {
                         background:randomColor,
                         name:item.name,
                         url:item.url
                      }
                     });
                     localStorage.setItem('pokmans_types', JSON.stringify(types));
                 }
                 let htmlTypes= "";
                 let len=18;
                 if(types.length<18){
                     len= types.length;
                 }
                 
                 for(let i=0;i<=len-1 ;i++){
                     let name = types[i].name;
                    
                     htmlTypes +=`<option value="${name}">${name}</option>`
                 }
                 document.getElementById("filter-type").innerHTML =`<select name="type" ><option value=""></option>${htmlTypes}</select>`
                 
             }

             function getCard(item){
                        return `<div id="pockman${item.id}" class="pokman">
                            <img src='${item.image}' />
                        <div class="section-title">
                            <h1>name:${item.name}</h1>
                            <span>type:${item.type.name}</span>
                            </div>
                            <div class="actionButton">
                                <button onclick="save('${item.id}')"  class="save">save</button>
                                <button  onclick="edit('${item.id}')"   class="edit">edit</button>
                                <button  onclick="deleteItem('${item.id}')"  class="delete">delete</button>
                                </div>
                        </div>`;
                                     
                    }
                    function getRandomColor() {
                                var letters = '0123456789ABCDEF';
                                var color = '#';
                                for (var i = 0; i < 6; i++) {
                                    color += letters[Math.floor(Math.random() * 16)];
                                }
                                return color;
                        }

                        function setBackgroundColor(allpockmans){
                            let types =  JSON.parse(localStorage.getItem("pokmans_types"));
                            let len = 50;
                            if(allpockmans.length<50){
                                len = allpockmans.length;
                            }
                            for(let i=0;i<=len-1;i++){
                              console.log("allpockmans[i].type",allpockmans[i].type,allpockmans[i].name)
                             document.getElementById("pockman"+allpockmans[i].id).style.background = types.find(item=>item.name==allpockmans[i].type.name).background
                            }
                        }

                        async function  getFilterData(type){
                        let fetchresult =  JSON.parse(localStorage.getItem("pokmans")); 
                        let res = await fetch(url_types+type).then(response => response.json())
                        let pokemon = res.pokemon;
                      
                         let fetchresult2 = fetchresult.filter(item=>item.type.name==type);
                         for(let i=0;i<=fetchresult2.length-1;i++){
                        let data = fetchresult2[i];
                        pokmans.push(data);
            
                        }
                        let htmlCards = "";
                        let len=50;
                        if(pokemon.length<50){
                            len = pokemon.length;
                        }

                       for(let i=0;i<=len-1;i++){
                        let item = pokemon[i].pokemon;
                        let newdata = await fetch(item.url).then(response => response.json());
                       
                       let data= {
                          id:newdata.id,
                          image:newdata.sprites.other.home.front_default,
                          name :newdata.name,
                          url:item.url,
                          type : {name:type,url:url_types+type}
                      }
                      
                        let data2 = pokmans.find(item2=>item2.name==data.name);
                        let data3 = fetchresult.find(item2=>(item2.name==data.name && item2.type.name!=type));
                        if(!data2){
                            pokmans.push(data);
                            fetchresult.push(data);
                        }
                      
                        
                        if(data3)
                        pokmans.push({...data3,type:data.type});
                      
                        }

                        len = 50;
                        if(pokmans.length<50)
                        len = pokmans.length;

                         pokmans.length =len;
                         for(let i=0;i<=len-1;i++){
                        let data = pokmans[i];
                        console.log()
                       
                        let card = getCard(data);
                        htmlCards +=card;
                        }
                        localStorage.setItem('pokmans', JSON.stringify(fetchresult));
                        pokmansContainer.innerHTML=(htmlCards);
                        setBackgroundColor(pokmans);
                        
                    }
    </script>
  </body>
</html>
